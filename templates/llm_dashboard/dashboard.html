
{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        height: 100%;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-change {
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .widget-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .widget-header {
        padding: 1.5rem 1.5rem 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }

    .widget-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #212529;
    }

    .widget-subtitle {
        font-size: 0.85rem;
        color: #6c757d;
        margin: 0;
    }

    .widget-body {
        padding: 1.5rem;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-loaded {
        background: #d4edda;
        color: #155724;
    }

    .status-loading {
        background: #fff3cd;
        color: #856404;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
    }

    .model-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .model-info-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .model-info-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 0.25rem;
    }

    .model-info-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .gpu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .gpu-widget {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .gpu-widget:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
    }

    .gpu-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .gpu-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-right: 1rem;
    }

    .gpu-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .gpu-subtitle {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .progress-item {
        margin-bottom: 1.5rem;
    }

    .progress-item:last-child {
        margin-bottom: 0;
    }

    .progress-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .progress-label {
        font-size: 0.85rem;
        color: #495057;
        font-weight: 500;
    }

    .progress-value {
        font-size: 0.85rem;
        font-weight: 600;
        color: #212529;
    }

    .progress-bar-custom {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .progress-fill.success {
        background: linear-gradient(90deg, #56ab2f 0%, #a8e6cf 100%);
    }

    .progress-fill.warning {
        background: linear-gradient(90deg, #f7971e 0%, #ffd200 100%);
    }

    .progress-fill.danger {
        background: linear-gradient(90deg, #d66d75 0%, #e29587 100%);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h4 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #495057;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }

    .btn-custom {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: none;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary-custom:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger-custom {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .btn-outline-custom {
        border-color: #dee2e6;
        color: #495057;
        background: white;
    }

    .btn-outline-custom:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
    }

    .requests-table {
        margin: 0;
    }

    .requests-table th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #495057;
        padding: 1rem;
    }

    .requests-table td {
        border: none;
        padding: 1rem;
        vertical-align: middle;
    }

    .requests-table tbody tr {
        border-bottom: 1px solid #f8f9fa;
    }

    .requests-table tbody tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.success {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.danger {
        background: #f8d7da;
        color: #721c24;
    }

    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #28a745;
    }

    .refresh-dot {
        width: 6px;
        height: 6px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Key Metrics -->
<div class="container mb-4">
    <div class="metric-grid">
        <div class="metric-card">
            <div class="metric-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">{{ stats.total_requests }}</div>
            <div class="metric-label">Total Requests</div>
            <div class="metric-change text-success">
                <i class="fas fa-arrow-up"></i> +{{ stats.hourly_requests }} this hour
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%); color: white;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value">{{ stats.hourly_requests }}</div>
            <div class="metric-label">Hourly Requests</div>
            <div class="metric-change text-info">
                <i class="fas fa-info-circle"></i> Last hour activity
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); color: white;">
                <i class="fas fa-stopwatch"></i>
            </div>
            <div class="metric-value">{{ stats.avg_duration|default:0|floatformat:2 }}s</div>
            <div class="metric-label">Avg Response Time</div>
            <div class="metric-change text-warning">
                <i class="fas fa-tachometer-alt"></i> Performance metric
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="metric-value">{{ stats.error_rate|floatformat:1 }}%</div>
            <div class="metric-label">Error Rate</div>
            <div class="metric-change {% if stats.error_rate > 5 %}text-danger{% else %}text-success{% endif %}">
                <i class="fas fa-{% if stats.error_rate > 5 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                {% if stats.error_rate > 5 %}Needs attention{% else %}Healthy{% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Model Management Widget -->
            <div class="widget-card">
                <div class="widget-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="widget-title">Model Management</h3>
                            <p class="widget-subtitle">Load and manage your AI models</p>
                        </div>
                        <button class="btn btn-primary-custom btn-custom" onclick="showLoadModelDialog()">
                            <i class="fas fa-plus me-2"></i>Load Model
                        </button>
                    </div>
                </div>
                <div class="widget-body">
                    {% if model %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                {% if model.status == 'LOADED' %}
                                    <i class="fas fa-robot fa-2x text-success"></i>
                                {% elif model.status == 'LOADING' %}
                                    <i class="fas fa-spinner fa-spin fa-2x text-warning"></i>
                                {% elif model.status == 'ERROR' %}
                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1">{{ model.name }}</h4>
                                <div class="status-indicator status-{{ model.status|lower }}">
                                    <div class="refresh-dot"></div>
                                    {{ model.status }}
                                </div>
                            </div>
                        </div>

                        <div class="model-info-grid">
                            <div class="model-info-item">
                                <div class="model-info-value">{{ model.memory_usage|floatformat:1 }}</div>
                                <div class="model-info-label">Memory (GB)</div>
                            </div>
                            <div class="model-info-item">
                                <div class="model-info-value">{{ model.tensor_parallel_size }}</div>
                                <div class="model-info-label">GPUs Used</div>
                            </div>
                            <div class="model-info-item">
                                <div class="model-info-value">{{ model.get_model_size_gb|floatformat:1 }}</div>
                                <div class="model-info-label">Model Size (GB)</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            {% if model.status == 'LOADED' %}
                                <button class="btn btn-primary-custom btn-custom" onclick="showTestDialog()">
                                    <i class="fas fa-play me-2"></i>Test Model
                                </button>
                                <button class="btn btn-danger-custom btn-custom" onclick="unloadModel({{ model.id }})">
                                    <i class="fas fa-stop me-2"></i>Unload
                                </button>
                            {% elif model.status == 'LOADING' %}
                                <button class="btn btn-outline-custom btn-custom" onclick="showLoadingLogsModal({{ model.id }})">
                                    <i class="fas fa-spinner loading-spinner me-2"></i>Loading...
                                </button>
                                <button class="btn btn-danger-custom btn-custom" onclick="stopLoading({{ model.id }})">
                                    <i class="fas fa-stop me-2"></i>Stop
                                </button>
                            {% elif model.status == 'ERROR' %}
                                <button class="btn btn-danger-custom btn-custom" onclick="showLoadingLogsModal({{ model.id }})">
                                    <i class="fas fa-exclamation-triangle me-2"></i>View Logs
                                </button>
                                <button class="btn btn-outline-custom btn-custom" onclick="unloadModel({{ model.id }})">
                                    <i class="fas fa-trash me-2"></i>Remove
                                </button>
                            {% endif %}

                            {% if model.loading_logs %}
                                <button class="btn btn-outline-custom btn-custom" onclick="showLoadingLogsModal({{ model.id }})">
                                    <i class="fas fa-file-alt me-2"></i>Logs
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h4>No Model Loaded</h4>
                            <p>Get started by loading your first LLM model</p>
                            <button class="btn btn-primary-custom btn-custom" onclick="showLoadModelDialog()">
                                <i class="fas fa-plus me-2"></i>Load Your First Model
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Requests Widget -->
            <div class="widget-card">
                <div class="widget-header">
                    <h3 class="widget-title">Recent Requests</h3>
                    <p class="widget-subtitle">Latest model interactions and performance</p>
                </div>
                <div class="widget-body p-0">
                    <div class="table-responsive">
                        <table class="table requests-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Model</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Tokens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in recent_requests %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ request.created_at|date:"M d" }}</div>
                                        <small class="text-muted">{{ request.created_at|date:"H:i" }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ request.model.name|default:"-" }}</strong>
                                    </td>
                                    <td>
                                        <span class="status-badge {% if request.status == 'COMPLETED' %}success{% elif request.status == 'ERROR' %}danger{% else %}warning{% endif %}">
                                            {{ request.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ request.duration|default:"-"|floatformat:2 }}s</strong>
                                    </td>
                                    <td>
                                        <strong>{{ request.tokens_generated }}</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                            No recent requests
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- GPU Statistics Widget -->
            <div class="widget-card">
                <div class="widget-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="widget-title">GPU Statistics</h3>
                            <p class="widget-subtitle">
                                <span id="gpu-count">{{ gpu_count }}</span> GPUs Available
                            </p>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                                <label class="form-check-label" for="autoRefreshToggle">
                                    Auto
                                </label>
                            </div>
                            <button class="btn btn-outline-custom btn-sm" id="refresh-button" onclick="refreshGPUStats(true)">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="refresh-indicator mt-2">
                        <div class="refresh-dot"></div>
                        <span>Auto-refreshing • Last updated: <span id="gpu-last-updated">{{ "now"|date:"H:i:s" }}</span></span>
                    </div>
                </div>
                <div class="widget-body">
                    <div class="gpu-grid" id="gpu-stats-content">
                        {% for gpu in gpu_stats %}
                            {% if gpu.error %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Unable to fetch GPU stats: {{ gpu.error }}
                                </div>
                            {% else %}
                                <div class="gpu-widget" data-gpu-id="{{ gpu.id }}">
                                    <div class="gpu-header">
                                        <div class="gpu-icon">
                                            <i class="fas fa-microchip"></i>
                                        </div>
                                        <div>
                                            <div class="gpu-title">{{ gpu.name }}</div>
                                            <div class="gpu-subtitle">GPU {{ gpu.id }}</div>
                                        </div>
                                    </div>

                                    <div class="progress-item">
                                        <div class="progress-header">
                                            <span class="progress-label">Memory Usage</span>
                                            <span class="progress-value memory-percentage">{{ gpu.memory_percentage }}%</span>
                                        </div>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill memory-progress {% if gpu.memory_percentage > 90 %}danger{% elif gpu.memory_percentage > 70 %}warning{% else %}success{% endif %}"
                                                 style="width: {{ gpu.memory_percentage }}%"></div>
                                        </div>
                                        <small class="text-muted memory-details">
                                            {{ gpu.memory_used|floatformat:1 }} / {{ gpu.memory_total|floatformat:1 }} GB
                                        </small>
                                    </div>

                                    <div class="progress-item">
                                        <div class="progress-header">
                                            <span class="progress-label">GPU Utilization</span>
                                            <span class="progress-value gpu-utilization">{{ gpu.gpu_utilization }}%</span>
                                        </div>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill utilization-progress {% if gpu.gpu_utilization > 90 %}danger{% elif gpu.gpu_utilization > 70 %}warning{% else %}success{% endif %}"
                                                 style="width: {{ gpu.gpu_utilization }}%"></div>
                                        </div>
                                    </div>

                                    <div class="progress-item">
                                        <div class="progress-header">
                                            <span class="progress-label">Temperature</span>
                                            <span class="progress-value temperature">{{ gpu.temperature }}°C</span>
                                        </div>
                                        <div class="progress-bar-custom">
                                            <div class="progress-fill temperature-progress {% if gpu.temperature > 80 %}danger{% elif gpu.temperature > 60 %}warning{% else %}success{% endif %}"
                                                 style="width: {{ gpu.temperature }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-custom btn-sm" onclick="forceCleanupGPUs()">
                            <i class="fas fa-broom me-1"></i>Force Cleanup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keep all existing modals (they remain the same) -->
<!-- Load Model Modal -->
<div class="modal fade" id="loadModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Load New Model</h5>
                    <small class="text-muted">Configure and load your LLM model</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loadModelForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="modelName" required placeholder="Enter model name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">GPUs to Use</label>
                            <select class="form-control" id="tensorParallelSize">
                                <option value="1">1 GPU</option>
                                {% for i in "12345678"|make_list %}
                                    {% if forloop.counter <= gpu_count %}
                                        <option value="{{ forloop.counter }}">{{ forloop.counter }} GPUs</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Model Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="modelPath" required readonly placeholder="Click Browse to select directory">
                            <button type="button" class="btn btn-outline-primary" onclick="showFileBrowser()">
                                <i class="fas fa-folder-open me-1"></i>Browse
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">GPU Memory Utilization</label>
                            <select class="form-control" id="gpuMemoryUtilization">
                                <option value="0.7">70%</option>
                                <option value="0.8">80%</option>
                                <option value="0.9" selected>90%</option>
                                <option value="0.95">95%</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" id="maxTokens" value="2048" placeholder="2048">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Data Type</label>
                        <select class="form-control" id="dtype">
                            <option value="auto">Auto</option>
                            <option value="float16">Float16</option>
                            <option value="bfloat16">BFloat16</option>
                            <option value="float32">Float32</option>
                        </select>
                        <small class="form-text text-muted">Float16 recommended for memory efficiency</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="loadModel()">
                    <i class="fas fa-rocket me-2"></i>Load Model
                </button>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div class="modal fade" id="fileBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Select Model Directory</h5>
                    <small class="text-muted">Browse and select your model files</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2 text-muted">Current Path:</span>
                        <code id="currentPath" class="flex-grow-1 bg-light p-2 rounded"></code>
                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="refreshDirectory()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="border rounded" style="height: 400px; overflow-y: auto;">
                    <div class="list-group list-group-flush" id="directoryList">
                        <div class="text-center p-4">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Model directories</strong> are highlighted and show a <span class="badge bg-success">Model</span> badge.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="flex-grow-1">
                    <span class="text-muted">Selected: </span>
                    <code id="selectedPath">None</code>
                </div>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectDirectory()" id="selectButton" disabled>
                    <i class="fas fa-check me-2"></i>Select Directory
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Model Modal -->
<div class="modal fade" id="testModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">Test Model</h5>
                    <small class="text-muted">Generate text and test model performance</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Prompt</label>
                    <textarea class="form-control" id="testPrompt" rows="4" placeholder="Enter your prompt here..." style="resize: vertical;"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Temperature</label>
                        <input type="number" class="form-control" id="testTemperature" value="0.7" step="0.1" min="0" max="2">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Top P</label>
                        <input type="number" class="form-control" id="testTopP" value="0.9" step="0.1" min="0" max="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" id="testMaxTokens" value="512" min="1">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="testModel()">
                        <i class="fas fa-play me-2"></i>Generate
                    </button>
                </div>
                <div class="mt-3" id="testResult" style="display: none;">
                    <label class="form-label">Response</label>
                    <div class="card">
                        <div class="card-body bg-light">
                            <div id="testResponse" style="white-space: pre-wrap; font-family: monospace;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Logs Modal -->
<div class="modal fade" id="loadingLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>Loading Logs
                        <span id="logModalStatus" class="badge ms-2"></span>
                    </h5>
                    <small class="text-muted">Model: <strong id="logModalModelName"></strong></small>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadLogs()">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body p-0">
                        <pre id="loadingLogsContent" class="bg-dark text-light p-3 mb-0" style="height: 500px; overflow-y: auto; font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; border-radius: 0.375rem;"></pre>
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="autoScrollLogs" checked>
                        <label class="form-check-label" for="autoScrollLogs">
                            Auto-scroll to bottom
                        </label>
                    </div>
                    <small class="text-muted">Last Updated: <span id="logModalLastUpdated"></span></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" onclick="clearLogs()">
                    <i class="fas fa-trash me-2"></i>Clear Logs
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentBrowsePath = '';
    let selectedDirectoryPath = '';
    let currentModelId = null;
    let logsRefreshInterval = null;
    let gpuStatsInterval = null;

    // Initialize auto-refresh when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Start GPU stats auto-refresh
        startGPUAutoRefresh();

        // Set up auto-refresh toggle
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startGPUAutoRefresh();
                } else {
                    stopGPUAutoRefresh();
                }
            });
        }
    });

    // GPU Auto-refresh functions
    function startGPUAutoRefresh() {
        // Clear existing interval if any
        stopGPUAutoRefresh();

        // Start new interval - refresh every 5 seconds
        gpuStatsInterval = setInterval(() => {
            refreshGPUStats(false); // false = silent refresh (no loading indicators)
        }, 1000);

        console.log('GPU auto-refresh started (every 5 seconds)');
    }

    function stopGPUAutoRefresh() {
        if (gpuStatsInterval) {
            clearInterval(gpuStatsInterval);
            gpuStatsInterval = null;
            console.log('GPU auto-refresh stopped');
        }
    }

    // Enhanced GPU stats refresh function
    function refreshGPUStats(manual = false) {
        const refreshButton = document.getElementById('refresh-button');

        // Show loading indicator only for manual refresh
        if (manual && refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshButton.disabled = true;
        }

        fetch('/llm-dashboard/api/gpu-stats/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateGPUStatsDisplay(data);
                } else {
                    console.error('Failed to fetch GPU stats:', data.error);
                    if (manual) {
                        showAlert('Failed to refresh GPU stats: ' + data.error, 'danger');
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching GPU stats:', error);
                if (manual) {
                    showAlert('Error fetching GPU stats: ' + error.message, 'danger');
                }
            })
            .finally(() => {
                // Reset refresh button only for manual refresh
                if (manual && refreshButton) {
                    refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    refreshButton.disabled = false;
                }
            });
    }

    function updateGPUStatsDisplay(data) {
        // Update GPU count and timestamp
        const gpuCountElement = document.getElementById('gpu-count');
        const lastUpdatedElement = document.getElementById('gpu-last-updated');

        if (gpuCountElement) {
            gpuCountElement.textContent = data.gpu_count;
        }

        if (lastUpdatedElement) {
            const now = new Date();
            lastUpdatedElement.textContent = now.toLocaleTimeString();
        }

        // Update each GPU card
        data.gpu_stats.forEach(gpu => {
            if (gpu.error) {
                // Handle GPU error case
                const errorContainer = document.querySelector('.alert-warning');
                if (errorContainer) {
                    errorContainer.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Unable to fetch GPU stats: ${gpu.error}
                    `;
                }
                return;
            }

            const gpuCard = document.querySelector(`[data-gpu-id="${gpu.id}"]`);
            if (!gpuCard) return;

            // Update memory usage
            const memoryPercentage = gpuCard.querySelector('.memory-percentage');
            const memoryProgress = gpuCard.querySelector('.memory-progress');
            const memoryDetails = gpuCard.querySelector('.memory-details');

            if (memoryPercentage) memoryPercentage.textContent = gpu.memory_percentage + '%';
            if (memoryDetails) memoryDetails.textContent = `${gpu.memory_used.toFixed(1)} / ${gpu.memory_total.toFixed(1)} GB`;

            if (memoryProgress) {
                memoryProgress.style.width = gpu.memory_percentage + '%';
                // Update color based on usage
                memoryProgress.className = `progress-fill memory-progress ${
                    gpu.memory_percentage > 90 ? 'danger' :
                    gpu.memory_percentage > 70 ? 'warning' : 'success'
                }`;
            }

            // Update GPU utilization
            const gpuUtilization = gpuCard.querySelector('.gpu-utilization');
            const utilizationProgress = gpuCard.querySelector('.utilization-progress');

            if (gpuUtilization) gpuUtilization.textContent = gpu.gpu_utilization + '%';

            if (utilizationProgress) {
                utilizationProgress.style.width = gpu.gpu_utilization + '%';
                utilizationProgress.className = `progress-fill utilization-progress ${
                    gpu.gpu_utilization > 90 ? 'danger' :
                    gpu.gpu_utilization > 70 ? 'warning' : 'success'
                }`;
            }

            // Update temperature
            const temperature = gpuCard.querySelector('.temperature');
            const temperatureProgress = gpuCard.querySelector('.temperature-progress');

            if (temperature) temperature.textContent = gpu.temperature + '°C';

            if (temperatureProgress) {
                temperatureProgress.style.width = gpu.temperature + '%';
                temperatureProgress.className = `progress-fill temperature-progress ${
                    gpu.temperature > 80 ? 'danger' :
                    gpu.temperature > 60 ? 'warning' : 'success'
                }`;
            }
        });
    }

    // Keep all existing JavaScript functions (they remain the same)
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    function showLoadingLogsModal(modelId) {
        currentModelId = modelId;
        const modal = new bootstrap.Modal(document.getElementById('loadingLogsModal'));
        modal.show();
        refreshLogs();
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
        }
        logsRefreshInterval = setInterval(() => {
            refreshLogs();
        }, 2000);
    }

    function refreshLogs() {
        if (!currentModelId) return;
        fetch(`/llm-dashboard/api/model/${currentModelId}/logs/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLogsDisplay(data);
                } else {
                    console.error('Failed to fetch logs:', data.error);
                    fetchLoadingLogsOld();
                }
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
                fetchLoadingLogsOld();
            });
    }

    function fetchLoadingLogsOld() {
        if (!currentModelId) return;
        fetch(`/llm-dashboard/get-logs/${currentModelId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('loadingLogsContent').textContent = `Error: ${data.error}`;
                    document.getElementById('logModalStatus').textContent = 'Error';
                    document.getElementById('logModalStatus').className = 'badge ms-2 bg-danger';
                } else {
                    const convertedData = {
                        logs: data.logs || 'No logs available',
                        status: data.status,
                        model_name: data.model_name || 'Unknown Model'
                    };
                    updateLogsDisplay(convertedData);
                }
            })
            .catch(error => {
                console.error('Error fetching logs (fallback):', error);
                document.getElementById('loadingLogsContent').textContent = `Error fetching logs: ${error.message}`;
            });
    }

    function updateLogsDisplay(data) {
        const logsContent = document.getElementById('loadingLogsContent');
        const modelName = document.getElementById('logModalModelName');
        const lastUpdated = document.getElementById('logModalLastUpdated');
        const status = document.getElementById('logModalStatus');

        modelName.textContent = data.model_name || 'Unknown Model';
        lastUpdated.textContent = new Date().toLocaleString();

        status.textContent = data.status;
        status.className = `badge ms-2 ${getStatusBadgeClass(data.status)}`;

        logsContent.textContent = data.logs || 'No logs available';

        const autoScroll = document.getElementById('autoScrollLogs');
        if (autoScroll && autoScroll.checked) {
            logsContent.scrollTop = logsContent.scrollHeight;
        }

        if (data.status !== 'LOADING' && logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
            logsRefreshInterval = null;
        }
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'LOADED': return 'bg-success';
            case 'LOADING': return 'bg-warning';
            case 'ERROR': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function downloadLogs() {
        const logsContent = document.getElementById('loadingLogsContent').textContent;
        const modelName = document.getElementById('logModalModelName').textContent;
        const blob = new Blob([logsContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${modelName}_loading_logs_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function clearLogs() {
        if (!currentModelId) return;
        if (confirm('Are you sure you want to clear all logs for this model?')) {
            fetch(`/llm-dashboard/api/model/${currentModelId}/clear-logs/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ confirm: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Logs cleared successfully', 'success');
                    refreshLogs();
                } else {
                    showAlert('Failed to clear logs: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error clearing logs:', error);
                showAlert('Error clearing logs: ' + error.message, 'danger');
            });
        }
    }

    function stopLoading(modelId) {
        if (confirm('Are you sure you want to stop loading this model?')) {
            fetch(`/llm-dashboard/stop-loading/${modelId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert('Model loading stopped successfully', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Failed to stop loading: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error stopping model loading:', error);
                showAlert('Error stopping model loading: ' + error.message, 'danger');
            });
        }
    }

    function showLoadModelDialog() {
        new bootstrap.Modal(document.getElementById('loadModelModal')).show();
    }

    function showTestDialog() {
        new bootstrap.Modal(document.getElementById('testModelModal')).show();
    }

    function loadModel() {
        const formData = {
            name: document.getElementById('modelName').value,
            model_path: document.getElementById('modelPath').value,
            tensor_parallel_size: parseInt(document.getElementById('tensorParallelSize').value),
            gpu_memory_utilization: parseFloat(document.getElementById('gpuMemoryUtilization').value),
            max_tokens: parseInt(document.getElementById('maxTokens').value),
            dtype: document.getElementById('dtype').value
        };

        if (!formData.name || !formData.model_path) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }

        fetch('/llm-dashboard/load-model/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Model loading started successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('loadModelModal')).hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('Failed to load model: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading model: ' + error.message, 'danger');
        });
    }

    function unloadModel(modelId) {
        if (confirm('Are you sure you want to unload this model?')) {
            fetch(`/llm-dashboard/unload-model/${modelId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Model unloaded successfully', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showAlert('Failed to unload model: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error unloading model: ' + error.message, 'danger');
            });
        }
    }

    function testModel() {
        const prompt = document.getElementById('testPrompt').value;
        if (!prompt.trim()) {
            showAlert('Please enter a prompt', 'warning');
            return;
        }

        const testData = {
            prompt: prompt,
            temperature: parseFloat(document.getElementById('testTemperature').value),
            top_p: parseFloat(document.getElementById('testTopP').value),
            max_tokens: parseInt(document.getElementById('testMaxTokens').value)
        };

        document.getElementById('testResult').style.display = 'block';
        document.getElementById('testResponse').textContent = 'Generating response...';

        fetch('/llm-dashboard/test-model/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('testResponse').textContent = data.response;
            } else {
                document.getElementById('testResponse').textContent = 'Error: ' + (data.error || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('testResponse').textContent = 'Error: ' + error.message;
        });
    }

    function showFileBrowser() {
        new bootstrap.Modal(document.getElementById('fileBrowserModal')).show();
        browseDirectory('');
    }

    function browseDirectory(path) {
        const directoryList = document.getElementById('directoryList');
        const currentPathElement = document.getElementById('currentPath');
        const selectButton = document.getElementById('selectButton');

        directoryList.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        `;

        selectedDirectoryPath = '';
        selectButton.disabled = true;
        document.getElementById('selectedPath').textContent = 'None';

        const url = path ? `/llm-dashboard/browse-directories/?path=${encodeURIComponent(path)}` : '/llm-dashboard/browse-directories/';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    directoryList.innerHTML = `
                        <div class="text-center p-4 text-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${data.error}
                        </div>
                    `;
                    return;
                }

                currentBrowsePath = data.current_path;
                currentPathElement.textContent = currentBrowsePath;

                let html = '';
                data.entries.forEach(entry => {
                    const isModel = entry.is_model;
                    const iconClass = entry.is_parent ? 'fas fa-level-up-alt' :
                                     isModel ? 'fas fa-robot' : 'fas fa-folder';
                    const rowClass = isModel ? 'list-group-item-success' : '';
                    const sizeText = entry.size ? ` (${entry.size} GB)` : '';

                    html += `
                        <div class="list-group-item list-group-item-action ${rowClass}"
                             data-path="${entry.path}"
                             data-is-model="${isModel}"
                             onclick="selectDirectoryItem('${entry.path}', ${isModel})"
                             ondblclick="navigateToDirectory('${entry.path}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="${iconClass} me-2"></i>
                                    <span>${entry.name}</span>
                                    ${isModel ? '<span class="badge bg-success ms-2">Model</span>' : ''}
                                </div>
                                <small class="text-muted">${sizeText}</small>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = `
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-folder-open"></i> Empty directory
                        </div>
                    `;
                }

                directoryList.innerHTML = html;
            })
            .catch(error => {
                directoryList.innerHTML = `
                    <div class="text-center p-4 text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading directory: ${error}
                    </div>
                `;
            });
    }

    function selectDirectoryItem(path, isModel) {
        document.querySelectorAll('#directoryList .list-group-item').forEach(item => {
            item.classList.remove('active');
        });

        event.currentTarget.classList.add('active');
        selectedDirectoryPath = path;
        document.getElementById('selectedPath').textContent = path;
        document.getElementById('selectButton').disabled = false;
    }

    function navigateToDirectory(path) {
        browseDirectory(path);
    }

    function refreshDirectory() {
        browseDirectory(currentBrowsePath);
    }

    function selectDirectory() {
        if (selectedDirectoryPath) {
            document.getElementById('modelPath').value = selectedDirectoryPath;

            const modelNameInput = document.getElementById('modelName');
            if (!modelNameInput.value.trim()) {
                const dirName = selectedDirectoryPath.split('/').pop();
                modelNameInput.value = dirName;
            }

            bootstrap.Modal.getInstance(document.getElementById('fileBrowserModal')).hide();
        }
    }

    function forceCleanupGPUs() {
        if (confirm('This will force cleanup all GPUs and kill all vLLM processes. Are you sure?')) {
            fetch('/llm-dashboard/force-cleanup-gpus/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('GPU cleanup completed successfully', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showAlert('GPU cleanup failed: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error during GPU cleanup: ' + error.message, 'danger');
            });
        }
    }

    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', function() {
        stopGPUAutoRefresh();
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
            logsRefreshInterval = null;
        }
    });

    // Clean up intervals when modal is closed
    document.getElementById('loadingLogsModal').addEventListener('hidden.bs.modal', function () {
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
            logsRefreshInterval = null;
        }
        currentModelId = null;
    });
</script>
{% endblock %}