{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Model Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Model Management</h5>
                    <button class="btn btn-success" onclick="showLoadModelDialog()">
                        <i class="fas fa-upload"></i> Load New Model
                    </button>
                </div>
                <div class="card-body">
                    {% if model %}
                        <div class="row">
                            <div class="col-md-8">
                                <h6>{{ model.name }}</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1">Status: <span class="badge {% if model.status == 'LOADED' %}bg-success{% elif model.status == 'LOADING' %}bg-warning{% else %}bg-danger{% endif %}">{{ model.status }}</span></p>
                                        <p class="mb-1">Memory Usage: {{ model.memory_usage|floatformat:2 }} GB</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">GPUs Used: {{ model.tensor_parallel_size }}</p>
                                        <p class="mb-1">Model Size: {{ model.get_model_size_gb|floatformat:2 }} GB</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2 justify-content-end flex-wrap">
                                    {% if model.status == 'LOADED' %}
                                        <button class="btn btn-danger" onclick="unloadModel({{ model.id }})">
                                            <i class="fas fa-stop"></i> Unload
                                        </button>
                                        <button class="btn btn-primary" onclick="showTestDialog()">
                                            <i class="fas fa-play"></i> Test
                                        </button>
                                    {% elif model.status == 'LOADING' %}
                                        <button class="btn btn-warning" onclick="showLoadingLogsModal({{ model.id }})">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </button>
                                        <button class="btn btn-danger" onclick="stopLoading({{ model.id }})">
                                            <i class="fas fa-stop"></i> Stop Loading
                                        </button>
                                    {% elif model.status == 'ERROR' %}
                                        <button class="btn btn-danger" onclick="showLoadingLogsModal({{ model.id }})">
                                            <i class="fas fa-exclamation-triangle"></i> View Error Logs
                                        </button>
                                        <button class="btn btn-secondary" onclick="unloadModel({{ model.id }})">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    {% else %}
                                        <button class="btn btn-secondary" onclick="unloadModel({{ model.id }})">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    {% endif %}

                                    <!-- Always show logs button if there are any logs -->
                                    {% if model.loading_logs %}
                                        <button class="btn btn-outline-info btn-sm" onclick="showLoadingLogsModal({{ model.id }})" title="View Loading Logs">
                                            <i class="fas fa-file-alt"></i> Logs
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-robot fa-3x text-muted"></i>
                            </div>
                            <h6 class="text-muted">No Model Loaded</h6>
                            <p class="text-muted mb-3">Click "Load New Model" to get started with your first LLM model.</p>
                            <button class="btn btn-success" onclick="showLoadModelDialog()">
                                <i class="fas fa-upload"></i> Load Your First Model
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- GPU Stats Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">GPU Statistics ({{ gpu_count }} GPUs Available)</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-button" onclick="refreshGPUStats()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-sm btn-danger" id="force-cleanup-button" onclick="forceCleanupGPUs()" title="Force cleanup all GPUs and kill all vLLM processes">
                        <i class="fas fa-exclamation-triangle"></i> Force Cleanup GPUs
                    </button>
                </div>
                <div class="card-body" id="gpu-stats-container">
                    <div class="row" id="gpu-stats-content">
                        {% for gpu in gpu_stats %}
                            {% if gpu.error %}
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        Unable to fetch GPU stats: {{ gpu.error }}
                                    </div>
                                </div>
                            {% else %}
                                <div class="col-md-6 col-xl-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">{{ gpu.name }} (GPU {{ gpu.id }})</h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Memory Usage Progress Bar -->
                                            <div class="mb-3">
                                                <label class="form-label">Memory Usage</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if gpu.memory_percentage > 90 %}bg-danger{% elif gpu.memory_percentage > 70 %}bg-warning{% else %}bg-success{% endif %}"
                                                         role="progressbar"
                                                         style="width: {{ gpu.memory_percentage }}%"
                                                         aria-valuenow="{{ gpu.memory_percentage }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{ gpu.memory_percentage }}%
                                                    </div>
                                                </div>
                                                <small class="text-muted">
                                                    Used: {{ gpu.memory_used|floatformat:1 }} GB /
                                                    Total: {{ gpu.memory_total|floatformat:1 }} GB
                                                </small>
                                            </div>

                                            <!-- GPU Utilization Progress Bar -->
                                            <div class="mb-3">
                                                <label class="form-label">GPU Utilization</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if gpu.gpu_utilization > 90 %}bg-danger{% elif gpu.gpu_utilization > 70 %}bg-warning{% else %}bg-success{% endif %}"
                                                         role="progressbar"
                                                         style="width: {{ gpu.gpu_utilization }}%"
                                                         aria-valuenow="{{ gpu.gpu_utilization }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{ gpu.gpu_utilization }}%
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Temperature -->
                                            <div class="mb-3">
                                                <label class="form-label">Temperature</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if gpu.temperature > 80 %}bg-danger{% elif gpu.temperature > 60 %}bg-warning{% else %}bg-success{% endif %}"
                                                         role="progressbar"
                                                         style="width: {{ gpu.temperature }}%"
                                                         aria-valuenow="{{ gpu.temperature }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100">
                                                        {{ gpu.temperature }}°C
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Total Requests</h6>
                    <h2>{{ stats.total_requests }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Requests (Last Hour)</h6>
                    <h2>{{ stats.hourly_requests }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Avg Duration</h6>
                    <h2>{{ stats.avg_duration|default:0|floatformat:2 }}s</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Error Rate</h6>
                    <h2>{{ stats.error_rate|floatformat:1 }}%</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Requests Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Requests</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Model</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Tokens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in recent_requests %}
                                <tr>
                                    <td>{{ request.created_at|date:"Y-m-d H:i:s" }}</td>
                                    <td>{{ request.model.name|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if request.status == 'COMPLETED' %}bg-success{% elif request.status == 'ERROR' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {{ request.status }}
                                        </span>
                                    </td>
                                    <td>{{ request.duration|default:"-"|floatformat:2 }}s</td>
                                    <td>{{ request.tokens_generated }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load Model Modal -->
<div class="modal fade" id="loadModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Load Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loadModelForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="modelName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="modelPath" required readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="showFileBrowser()">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <small class="form-text text-muted">Click Browse to select the model directory</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">GPUs to Use (Tensor Parallel Size)</label>
                        <select class="form-control" id="tensorParallelSize">
                            <option value="1">1 GPU</option>
                            {% for i in "12345678"|make_list %}
                                {% if forloop.counter <= gpu_count %}
                                    <option value="{{ forloop.counter }}">{{ forloop.counter }} GPUs</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">GPU Memory Utilization</label>
                        <select class="form-control" id="gpuMemoryUtilization">
                            <option value="0.7">70%</option>
                            <option value="0.8">80%</option>
                            <option value="0.9" selected>90%</option>
                            <option value="0.95">95%</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" id="maxTokens" value="2048">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data Type</label>
                        <select class="form-control" id="dtype">
                            <option value="auto">Auto</option>
                            <option value="float16">Float16</option>
                            <option value="bfloat16">BFloat16</option>
                            <option value="float32">Float32</option>
                        </select>
                        <small class="form-text text-muted">Data type for model weights (float16 recommended for memory efficiency)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="loadModel()">Load Model</button>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div class="modal fade" id="fileBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Model Directory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2">Current Path:</span>
                        <code id="currentPath" class="flex-grow-1"></code>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="refreshDirectory()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="border" style="height: 400px; overflow-y: auto;">
                    <div class="list-group list-group-flush" id="directoryList">
                        <div class="text-center p-4">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Model directories</strong> are highlighted in green and show a <span class="badge bg-success">Model</span> badge.
                        Click a directory to select it.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="flex-grow-1">
                    <span class="text-muted">Selected: </span>
                    <code id="selectedPath">None</code>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectDirectory()" id="selectButton" disabled>
                    Select Directory
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Model Modal -->
<div class="modal fade" id="testModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Prompt</label>
                    <textarea class="form-control" id="testPrompt" rows="4" placeholder="Enter your prompt here..."></textarea>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Temperature</label>
                        <input type="number" class="form-control" id="testTemperature" value="0.7" step="0.1" min="0" max="2">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Top P</label>
                        <input type="number" class="form-control" id="testTopP" value="0.9" step="0.1" min="0" max="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-control" id="testMaxTokens" value="512" min="1">
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="testModel()">Generate</button>
                </div>
                <div class="mt-3" id="testResult" style="display: none;">
                    <label class="form-label">Response</label>
                    <div class="card">
                        <div class="card-body">
                            <div id="testResponse"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FIXED: Loading Logs Modal -->
<div class="modal fade" id="loadingLogsModal" tabindex="-1" aria-labelledby="loadingLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadingLogsModalLabel">
                    <i class="fas fa-file-alt"></i> Loading Logs
                    <span id="logModalStatus" class="badge ms-2"></span>
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadLogs()">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Model: <strong id="logModalModelName"></strong></span>
                        <span>Last Updated: <span id="logModalLastUpdated"></span></span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body p-2">
                        <pre id="loadingLogsContent" class="bg-dark text-light p-3 mb-0" style="height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></pre>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="autoScrollLogs" checked>
                        <label class="form-check-label" for="autoScrollLogs">
                            Auto-scroll to bottom
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentBrowsePath = '';
    let selectedDirectoryPath = '';
    let currentModelId = null;
    let logsRefreshInterval = null;

    // CSRF token helper
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // FIXED: Enhanced logs modal functionality
    function showLoadingLogsModal(modelId) {
        currentModelId = modelId;

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('loadingLogsModal'));
        modal.show();

        // Load initial logs
        refreshLogs();

        // Set up auto-refresh for active loading
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
        }

        // Auto-refresh every 2 seconds if model is still loading
        logsRefreshInterval = setInterval(() => {
            refreshLogs();
        }, 2000);
    }

    function refreshLogs() {
        if (!currentModelId) return;

        // FIXED: Use correct URL with hyphen
        fetch(`/llm-dashboard/api/model/${currentModelId}/logs/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLogsDisplay(data);
                } else {
                    console.error('Failed to fetch logs:', data.error);
                    // Fallback to old endpoint if new one doesn't exist
                    fetchLoadingLogsOld();
                }
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
                // Fallback to old endpoint
                fetchLoadingLogsOld();
            });
    }

    // Fallback function for existing endpoint
    function fetchLoadingLogsOld() {
        if (!currentModelId) return;

        // FIXED: Use correct URL with hyphen
        fetch(`/llm-dashboard/get-logs/${currentModelId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('loadingLogsContent').textContent = `Error: ${data.error}`;
                    document.getElementById('logModalStatus').textContent = 'Error';
                    document.getElementById('logModalStatus').className = 'badge ms-2 bg-danger';
                } else {
                    // Convert old format to new format
                    const convertedData = {
                        logs: data.logs || 'No logs available',
                        status: data.status,
                        model_name: data.model_name || 'Unknown Model'
                    };
                    updateLogsDisplay(convertedData);
                }
            })
            .catch(error => {
                console.error('Error fetching logs (fallback):', error);
                document.getElementById('loadingLogsContent').textContent = `Error fetching logs: ${error.message}`;
            });
    }

    function updateLogsDisplay(data) {
        const logsContent = document.getElementById('loadingLogsContent');
        const modelName = document.getElementById('logModalModelName');
        const lastUpdated = document.getElementById('logModalLastUpdated');
        const status = document.getElementById('logModalStatus');

        // Update content
        modelName.textContent = data.model_name || 'Unknown Model';
        lastUpdated.textContent = new Date().toLocaleString();

        // Update status badge
        status.textContent = data.status;
        status.className = `badge ms-2 ${getStatusBadgeClass(data.status)}`;

        // Update logs content
        logsContent.textContent = data.logs || 'No logs available';

        // Auto-scroll to bottom if enabled
        const autoScroll = document.getElementById('autoScrollLogs');
        if (autoScroll && autoScroll.checked) {
            logsContent.scrollTop = logsContent.scrollHeight;
        }

        // Stop auto-refresh if model is no longer loading
        if (data.status !== 'LOADING' && logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
            logsRefreshInterval = null;
        }
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'LOADED': return 'bg-success';
            case 'LOADING': return 'bg-warning';
            case 'ERROR': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function downloadLogs() {
        const logsContent = document.getElementById('loadingLogsContent').textContent;
        const modelName = document.getElementById('logModalModelName').textContent;

        const blob = new Blob([logsContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${modelName}_loading_logs_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function clearLogs() {
        if (!currentModelId) return;

        if (confirm('Are you sure you want to clear all logs for this model?')) {
            fetch(`/llm-dashboard/api/model/${currentModelId}/clear-logs/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                // FIXED: Include the required confirmation parameter
                body: JSON.stringify({
                    confirm: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Logs cleared successfully', 'success');
                    refreshLogs(); // Refresh to show empty logs
                } else {
                    showAlert('Failed to clear logs: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error clearing logs:', error);
                showAlert('Error clearing logs: ' + error.message, 'danger');
            });
        }
    }


    // Clean up intervals when modal is closed
    document.getElementById('loadingLogsModal').addEventListener('hidden.bs.modal', function () {
        if (logsRefreshInterval) {
            clearInterval(logsRefreshInterval);
            logsRefreshInterval = null;
        }
        currentModelId = null;
    });

    function stopLoading(modelId) {
        if (confirm('Are you sure you want to stop loading this model?')) {
            // FIXED: Use correct URL with hyphen, not underscore
            fetch(`/llm-dashboard/stop-loading/${modelId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                // Check if response is ok before parsing JSON
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert('Model loading stopped successfully', 'success');
                    // Refresh page to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Failed to stop loading: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error stopping model loading:', error);
                showAlert('Error stopping model loading: ' + error.message, 'danger');
            });
        }
    }



    // File browser functionality
    function showFileBrowser() {
        new bootstrap.Modal(document.getElementById('fileBrowserModal')).show();
        browseDirectory('');
    }

    function browseDirectory(path) {
        const directoryList = document.getElementById('directoryList');
        const currentPathElement = document.getElementById('currentPath');
        const selectButton = document.getElementById('selectButton');

        directoryList.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        `;

        selectedDirectoryPath = '';
        selectButton.disabled = true;
        document.getElementById('selectedPath').textContent = 'None';

        const url = path ? `/llm-dashboard/browse-directories/?path=${encodeURIComponent(path)}` : '/llm-dashboard/browse-directories/';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    directoryList.innerHTML = `
                        <div class="text-center p-4 text-danger">
                            <i class="fas fa-exclamation-triangle"></i> ${data.error}
                        </div>
                    `;
                    return;
                }

                currentBrowsePath = data.current_path;
                currentPathElement.textContent = currentBrowsePath;

                let html = '';
                data.entries.forEach(entry => {
                    const isModel = entry.is_model;
                    const iconClass = entry.is_parent ? 'fas fa-level-up-alt' :
                                     isModel ? 'fas fa-robot' : 'fas fa-folder';
                    const rowClass = isModel ? 'list-group-item-success' : '';
                    const sizeText = entry.size ? ` (${entry.size} GB)` : '';

                    html += `
                        <div class="list-group-item list-group-item-action ${rowClass}"
                             data-path="${entry.path}"
                             data-is-model="${isModel}"
                             onclick="selectDirectoryItem('${entry.path}', ${isModel})"
                             ondblclick="navigateToDirectory('${entry.path}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="${iconClass} me-2"></i>
                                    <span>${entry.name}</span>
                                    ${isModel ? '<span class="badge bg-success ms-2">Model</span>' : ''}
                                </div>
                                <small class="text-muted">${sizeText}</small>
                            </div>
                        </div>
                    `;
                });

                if (html === '') {
                    html = `
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-folder-open"></i> Empty directory
                        </div>
                    `;
                }

                directoryList.innerHTML = html;
            })
            .catch(error => {
                directoryList.innerHTML = `
                    <div class="text-center p-4 text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading directory: ${error}
                    </div>
                `;
            });
    }

    function selectDirectoryItem(path, isModel) {
        document.querySelectorAll('#directoryList .list-group-item').forEach(item => {
            item.classList.remove('active');
        });

        event.currentTarget.classList.add('active');
        selectedDirectoryPath = path;
        document.getElementById('selectedPath').textContent = path;
        document.getElementById('selectButton').disabled = false;
    }

    function navigateToDirectory(path) {
        browseDirectory(path);
    }

    function refreshDirectory() {
        browseDirectory(currentBrowsePath);
    }

    function selectDirectory() {
        if (selectedDirectoryPath) {
            document.getElementById('modelPath').value = selectedDirectoryPath;

            const modelNameInput = document.getElementById('modelName');
            if (!modelNameInput.value.trim()) {
                const dirName = selectedDirectoryPath.split('/').pop();
                modelNameInput.value = dirName;
            }

            bootstrap.Modal.getInstance(document.getElementById('fileBrowserModal')).hide();
        }
    }

    // GPU stats refresh
    function refreshGPUStats() {
        const button = document.getElementById('refresh-button');
        const icon = button.querySelector('i');

        icon.classList.add('fa-spin');
        button.disabled = true;

        fetch('/llm-dashboard/stats/')
            .then(response => response.json())
            .then(data => {
                if (data.gpu_stats) {
                    updateGPUStats(data.gpu_stats);
                }
            })
            .catch(error => {
                console.error('Error refreshing GPU stats:', error);
            })
            .finally(() => {
                icon.classList.remove('fa-spin');
                button.disabled = false;
            });
    }

    function updateGPUStats(gpuStats) {
        const container = document.getElementById('gpu-stats-content');
        if (!container || !gpuStats) return;

        let html = '';
        gpuStats.forEach(gpu => {
            if (gpu.error) {
                html += `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Unable to fetch GPU stats: ${gpu.error}
                        </div>
                    </div>
                `;
            } else {
                const memoryColor = gpu.memory_percentage > 90 ? 'bg-danger' :
                                   gpu.memory_percentage > 70 ? 'bg-warning' : 'bg-success';
                const gpuColor = gpu.gpu_utilization > 90 ? 'bg-danger' :
                                gpu.gpu_utilization > 70 ? 'bg-warning' : 'bg-success';
                const tempColor = gpu.temperature > 80 ? 'bg-danger' :
                                 gpu.temperature > 60 ? 'bg-warning' : 'bg-success';

                html += `
                    <div class="col-md-6 col-xl-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">${gpu.name} (GPU ${gpu.id})</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Memory Usage</label>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${memoryColor}"
                                             role="progressbar"
                                             style="width: ${gpu.memory_percentage}%">
                                            ${gpu.memory_percentage}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Used: ${gpu.memory_used.toFixed(1)} GB /
                                        Total: ${gpu.memory_total.toFixed(1)} GB
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">GPU Utilization</label>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${gpuColor}"
                                             role="progressbar"
                                             style="width: ${gpu.gpu_utilization}%">
                                            ${gpu.gpu_utilization}%
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Temperature</label>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar ${tempColor}"
                                             role="progressbar"
                                             style="width: ${gpu.temperature}%">
                                            ${gpu.temperature}°C
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        container.innerHTML = html;
    }

    // Model management functions
    function showLoadModelDialog() {
        new bootstrap.Modal(document.getElementById('loadModelModal')).show();
    }

    function showTestDialog() {
        new bootstrap.Modal(document.getElementById('testModelModal')).show();
    }

    function loadModel() {
        const modelPath = document.getElementById('modelPath').value;
        const modelName = document.getElementById('modelName').value;
        const tensorParallelSize = document.getElementById('tensorParallelSize').value;
        const gpuMemoryUtilization = document.getElementById('gpuMemoryUtilization').value;
        const maxTokens = document.getElementById('maxTokens').value;
        const dtype = document.getElementById('dtype').value;

        if (!modelPath || !modelName) {
            alert('Please fill in all required fields');
            return;
        }

        const loadButton = event.target;
        loadButton.disabled = true;
        loadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

        const data = {
            name: modelName,
            model_path: modelPath,
            tensor_parallel_size: parseInt(tensorParallelSize),
            gpu_memory_utilization: parseFloat(gpuMemoryUtilization),
            max_tokens: parseInt(maxTokens),
            dtype: dtype
        };

        fetch('/llm-dashboard/load-model/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('loadModelModal')).hide();
                location.reload();
            } else {
                alert('Error loading model: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading model: ' + error.message);
        })
        .finally(() => {
            loadButton.disabled = false;
            loadButton.innerHTML = 'Load Model';
        });
    }

    function forceCleanupGPUs() {
        if (confirm('⚠️ WARNING: This will forcefully terminate ALL vLLM processes and clear GPU memory!\n\nThis action will:\n• Kill all running model processes\n• Clear GPU memory on all devices\n• Reset all model statuses to UNLOADED\n• Stop Ray cluster if running\n\nAre you sure you want to continue?')) {

            const button = document.getElementById('force-cleanup-button');
            const icon = button.querySelector('i');
            const originalText = button.innerHTML;

            // Show loading state
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cleaning...';

            fetch('/llm-dashboard/force-cleanup-gpus/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Force GPU cleanup completed successfully!', 'success');

                    // Show cleanup details if available
                    if (data.details && data.details.length > 0) {
                        const detailsText = data.details.join('\n');
                        console.log('Cleanup details:', detailsText);

                        // Show details in a collapsible alert
                        const detailsHtml = `
                            <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
                                <strong>Cleanup Details:</strong>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#cleanupDetails" aria-expanded="false">
                                        Show Details
                                    </button>
                                </div>
                                <div class="collapse mt-2" id="cleanupDetails">
                                    <pre class="small mb-0">${detailsText}</pre>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;

                        // Add details to the page
                        const container = document.querySelector('.container-fluid');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = detailsHtml;
                        container.insertBefore(tempDiv.firstElementChild, container.firstElementChild);
                    }

                    // Refresh the page after a short delay to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);

                } else {
                    showAlert('Force cleanup failed: ' + (data.error || 'Unknown error'), 'danger');

                    // Show error details if available
                    if (data.details && data.details.length > 0) {
                        console.error('Cleanup errors:', data.details);
                    }
                }
            })
            .catch(error => {
                console.error('Error during force cleanup:', error);
                showAlert('Error during force cleanup: ' + error.message, 'danger');
            })
            .finally(() => {
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }
    }

    // Helper function to show alerts
    function showAlert(message, type) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Insert at top of container
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertContainer, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertContainer.parentNode) {
                alertContainer.remove();
            }
        }, 5000);
    }

    // Add periodic status check for loading models
    function checkModelStatus() {
        // Only check if there's a model visible
        const modelCard = document.querySelector('.card-body h6');
        if (!modelCard) return;

        // Check if model is in loading state
        const statusBadge = document.querySelector('.badge');
        if (statusBadge && statusBadge.textContent.trim() === 'LOADING') {
            // Refresh page every 10 seconds if model is loading
            setTimeout(() => {
                window.location.reload();
            }, 10000);
        }
    }

    // Start status checking when page loads
    document.addEventListener('DOMContentLoaded', function() {
        checkModelStatus();
    });


    function unloadModel(modelId) {
        if (confirm('Are you sure you want to unload this model?')) {
            fetch(`/llm-dashboard/unload-model/${modelId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Model unloaded successfully', 'success');
                    // Refresh page to update UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showAlert('Failed to unload model: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error unloading model:', error);
                showAlert('Error unloading model: ' + error.message, 'danger');
            });
        }
    }

    function testModel() {
        const prompt = document.getElementById('testPrompt').value;
        const temperature = parseFloat(document.getElementById('testTemperature').value);
        const topP = parseFloat(document.getElementById('testTopP').value);
        const maxTokens = parseInt(document.getElementById('testMaxTokens').value);

        if (!prompt.trim()) {
            alert('Please enter a prompt');
            return;
        }

        const generateButton = event.target;
        generateButton.disabled = true;
        generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        const data = {
            prompt: prompt,
            temperature: temperature,
            top_p: topP,
            max_tokens: maxTokens
        };

        fetch('/llm-dashboard/test-model/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('testResponse').textContent = data.response;
                document.getElementById('testResult').style.display = 'block';
            } else {
                alert('Error testing model: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error testing model: ' + error.message);
        })
        .finally(() => {
            generateButton.disabled = false;
            generateButton.innerHTML = 'Generate';
        });
    }
</script>
{% endblock %}